<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FlyNova ACARS - Dashboard</title>
  <link rel="stylesheet" href="../styles/main.css">
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <img src="../../logos/logo_flynova.png" alt="FlyNova" class="header-logo">
        <div class="header-title">
          <h2>FlyNova ACARS</h2>
          <p>Flight Tracking System</p>
        </div>
      </div>
      <div class="user-info">
        <div class="user-name">
          <p id="userName">Pilot</p>
          <span id="userStatus">Online</span>
        </div>
        <button class="btn-logout" onclick="logout()">Logout</button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
      <!-- Loading State -->
      <div id="loadingState" class="loading">
        <div class="spinner"></div>
        <p>Loading your reservation...</p>
      </div>

      <!-- No Reservation State -->
      <div id="noReservationState" class="no-reservation" style="display: none;">
        <div class="no-reservation-icon">‚úàÔ∏è</div>
        <h3>No Active Reservation</h3>
        <p>You currently have no booked flights.</p>
        <p>Visit the FlyNova website to book a flight.</p>
      </div>

      <!-- Reservation Card -->
      <div id="reservationCard" class="reservation-card" style="display: none;">
        <!-- VA Branding Bar -->
        <div class="va-branding" id="vaBrandingBar"></div>

        <!-- Reservation Header -->
        <div class="reservation-header">
          <div class="va-info">
            <img id="vaLogo" class="va-logo" src="" alt="VA Logo">
            <div class="va-details">
              <h3 id="vaName">Virtual Airline</h3>
              <p id="vaCallsign">Callsign</p>
            </div>
          </div>
          <div class="flight-number">
            <h2 id="flightNumber">FLY001</h2>
          </div>
        </div>

        <!-- Flight Route -->
        <div class="flight-route">
          <div class="airport">
            <div class="airport-code" id="departureIcao">LFPG</div>
            <div class="airport-name" id="departureName">Paris Charles de Gaulle</div>
          </div>
          <div class="route-line">
            <div class="route-arrow"></div>
          </div>
          <div class="airport">
            <div class="airport-code" id="arrivalIcao">KJFK</div>
            <div class="airport-name" id="arrivalName">New York JFK</div>
          </div>
        </div>

        <!-- Flight Info Grid -->
        <div class="flight-info-grid">
          <div class="info-item">
            <div class="info-label">Aircraft Type</div>
            <div class="info-value" id="aircraftType">B777-300ER</div>
          </div>
          <div class="info-item">
            <div class="info-label">Registration</div>
            <div class="info-value" id="registration">N/A</div>
          </div>
          <div class="info-item">
            <div class="info-label">Route Type</div>
            <div class="info-value" id="routeType">Civil</div>
          </div>
          <div class="info-item">
            <div class="info-label">Status</div>
            <div id="flightStatus" class="status-badge status-reserved">Reserved</div>
          </div>
        </div>

        <!-- Flight Progress (shown during flight) -->
        <div id="flightProgress" class="flight-progress" style="display: none;">
          <div class="progress-header">
            <h3>Flight Progress</h3>
            <span id="progressPercentage">0%</span>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar" style="width: 0%;">
              <span class="progress-plane">‚úàÔ∏è</span>
            </div>
            <div class="progress-text" id="progressText">Waiting for departure</div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <button id="btnStart" class="btn btn-start" onclick="startFlight()">
            üõ´ Start Flight
          </button>
          <button id="btnEnd" class="btn btn-end" onclick="endFlight()" style="display: none;">
            üõ¨ End Flight
          </button>
          <button class="btn btn-cancel" onclick="cancelFlight()">
            ‚ùå Cancel
          </button>
        </div>
      </div>
    </main>
  </div>

  <script src="../services/api.js"></script>
  <script src="../services/flight-tracker.js"></script>
  <script>
    let currentFlight = null;
    let flightTracker = null;

    // Check authentication
    if (!StorageService.isAuthenticated()) {
      window.location.href = 'login.html';
    }

    // Load user info
    const auth = StorageService.getAuth();
    document.getElementById('userName').textContent = auth.username;

    // Logout function
    function logout() {
      if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')) {
        if (flightTracker) {
          flightTracker.stop();
        }
        StorageService.clearAuth();
        window.location.href = 'login.html';
      }
    }

    // Load active reservation
    async function loadReservation() {
      const loadingState = document.getElementById('loadingState');
      const noReservationState = document.getElementById('noReservationState');
      const reservationCard = document.getElementById('reservationCard');

      try {
        const reservation = await APIService.getActiveReservation(auth.userId, auth.token);

        if (reservation && reservation.flight) {
          currentFlight = reservation.flight;
          displayReservation(reservation);
          
          loadingState.style.display = 'none';
          reservationCard.style.display = 'block';

          // If flight is in progress, initialize tracker
          if (currentFlight.status === 'in_progress') {
            initializeTracker();
          }
        } else {
          loadingState.style.display = 'none';
          noReservationState.style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading reservation:', error);
        loadingState.style.display = 'none';
        noReservationState.style.display = 'block';
      }
    }

    // Display reservation details
    function displayReservation(data) {
      const { flight, route, va, fleet } = data;

      console.log('VA Logo URL:', va.logo_url);

      // Set VA branding colors
      if (va.primary_color) {
        document.documentElement.style.setProperty('--primary-color', va.primary_color);
        document.getElementById('vaBrandingBar').style.background = va.primary_color;
      }
      if (va.secondary_color) {
        document.documentElement.style.setProperty('--secondary-color', va.secondary_color);
      }
      if (va.accent_color) {
        document.documentElement.style.setProperty('--accent-color', va.accent_color);
      }

      // Set VA info with logo
      const vaLogoElement = document.getElementById('vaLogo');
      if (va.logo_url && va.logo_url.trim() !== '') {
        // Si le logo_url est une URL compl√®te, l'utiliser directement
        if (va.logo_url.startsWith('http://') || va.logo_url.startsWith('https://')) {
          vaLogoElement.src = va.logo_url;
        } 
        // Si c'est un chemin relatif vers uploads
        else if (va.logo_url.startsWith('/uploads/')) {
          vaLogoElement.src = 'http://localhost:3000' + va.logo_url;
        }
        // Sinon, chemin complet fourni
        else {
          vaLogoElement.src = va.logo_url;
        }
        
        // Gestion des erreurs de chargement
        vaLogoElement.onerror = function() {
          console.error('Erreur chargement logo:', va.logo_url);
          this.src = '../../logos/logo_flynova.png';
        };
      } else {
        // Utiliser le logo par d√©faut si pas de logo_url
        vaLogoElement.src = '../../logos/logo_flynova.png';
      }
      
      document.getElementById('vaName').textContent = va.name;
      document.getElementById('vaCallsign').textContent = va.callsign;

      // Set flight info
      document.getElementById('flightNumber').textContent = route.flight_number;
      document.getElementById('departureIcao').textContent = route.departure_icao;
      document.getElementById('departureName').textContent = route.departure_name;
      document.getElementById('arrivalIcao').textContent = route.arrival_icao;
      document.getElementById('arrivalName').textContent = route.arrival_name;
      document.getElementById('aircraftType').textContent = route.aircraft_type || 'N/A';
      document.getElementById('routeType').textContent = route.route_type;
      
      if (fleet) {
        document.getElementById('registration').textContent = fleet.registration;
      }

      // Set status
      updateFlightStatus(flight.status);
    }

    // Update flight status display
    function updateFlightStatus(status) {
      const statusBadge = document.getElementById('flightStatus');
      const btnStart = document.getElementById('btnStart');
      const btnEnd = document.getElementById('btnEnd');
      const flightProgress = document.getElementById('flightProgress');

      statusBadge.className = 'status-badge';

      switch (status) {
        case 'reserved':
          statusBadge.classList.add('status-reserved');
          statusBadge.textContent = 'Reserved';
          btnStart.style.display = 'block';
          btnEnd.style.display = 'none';
          flightProgress.style.display = 'none';
          break;
        case 'in_progress':
          statusBadge.classList.add('status-in-progress');
          statusBadge.textContent = 'In Progress';
          btnStart.style.display = 'none';
          btnEnd.style.display = 'block';
          flightProgress.style.display = 'block';
          break;
        case 'completed':
          statusBadge.classList.add('status-completed');
          statusBadge.textContent = 'Completed';
          btnStart.style.display = 'none';
          btnEnd.style.display = 'none';
          break;
      }

      if (currentFlight) {
        currentFlight.status = status;
      }
    }

    // Start flight
    async function startFlight() {
      if (!currentFlight) return;

      if (confirm('Start flight now?')) {
        try {
          const btnStart = document.getElementById('btnStart');
          btnStart.disabled = true;
          btnStart.textContent = 'Starting...';

          await APIService.updateFlightStatus(currentFlight.id, 'in_progress', auth.token);
          updateFlightStatus('in_progress');
          
          // Initialize flight tracker
          initializeTracker();

          alert('Flight started successfully!');
        } catch (error) {
          console.error('Error starting flight:', error);
          alert('Error starting flight');
          btnStart.disabled = false;
          btnStart.textContent = 'üõ´ Start Flight';
        }
      }
    }

    // Initialize flight tracker
    async function initializeTracker() {
      if (!flightTracker) {
        try {
          flightTracker = new FlightTracker(currentFlight, auth.token);
          flightTracker.onUpdate = (data) => {
            updateProgress(data);
          };
          await flightTracker.start();
        } catch (error) {
          console.error('‚ùå Tracker initialization failed:', error);
          
          // Show error to user
          alert(error.message || 'Error connecting to simulator.\n\nPlease verify that MSFS 2020 is running and you are in flight.');
          
          // Revert flight status
          try {
            await APIService.updateFlightStatus(currentFlight.id, 'reserved', auth.token);
            updateFlightStatus('reserved');
          } catch (e) {
            console.error('Failed to revert status:', e);
          }
          
          // Re-enable start button
          const btnStart = document.getElementById('btnStart');
          btnStart.disabled = false;
          btnStart.textContent = 'üõ´ Start Flight';
          
          // Clean up tracker
          flightTracker = null;
          
          throw error;
        }
      }
    }

    // Update flight progress
    function updateProgress(data) {
      const progressBar = document.getElementById('progressBar');
      const progressPercentage = document.getElementById('progressPercentage');
      const progressText = document.getElementById('progressText');

      const percentage = Math.min(100, Math.max(0, data.progress || 0));
      
      progressBar.style.width = `${percentage}%`;
      progressPercentage.textContent = `${percentage.toFixed(1)}%`;
      
      if (data.phase) {
        progressText.textContent = data.phase;
      }
    }

    // End flight
    async function endFlight() {
      if (!currentFlight) return;

      if (confirm('Terminer le vol et envoyer le rapport ?')) {
        try {
          const btnEnd = document.getElementById('btnEnd');
          btnEnd.disabled = true;
          btnEnd.textContent = 'Submitting...';

          // Get flight data from tracker
          const flightData = flightTracker ? flightTracker.getFlightData() : {};

          // Submit flight report
          await APIService.submitFlightReport(currentFlight.id, flightData, auth.token);
          
          // Stop tracker
          if (flightTracker) {
            flightTracker.stop();
          }

          alert('Flight completed and report submitted successfully!');
          
          // Reload to show new state
          location.reload();
        } catch (error) {
          console.error('Error ending flight:', error);
          alert('Error submitting report');
          btnEnd.disabled = false;
          btnEnd.textContent = 'üõ¨ End Flight';
        }
      }
    }

    // Cancel flight
    async function cancelFlight() {
      if (!currentFlight) return;

      if (confirm('Are you sure you want to cancel this flight? This will delete the reservation.')) {
        try {
          await APIService.cancelFlight(currentFlight.id, auth.token);
          
          // Stop tracker if running
          if (flightTracker) {
            flightTracker.stop();
          }

          alert('Flight cancelled successfully');
          location.reload();
        } catch (error) {
          console.error('Error canceling flight:', error);
          alert('Error cancelling flight');
        }
      }
    }

    // Load reservation on page load
    loadReservation();
  </script>
</body>
</html>
